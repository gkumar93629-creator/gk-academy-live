<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GK Academy Challenge - Live Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body { background-color: #0f172a; font-family: 'Poppins', sans-serif; }
        .glass-card { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-primary { background: #f59e0b; color: #1e293b; font-weight: bold; transition: all 0.2s; }
        .btn-primary:hover:not(:disabled) { background: #fbbf24; }
        .btn-primary:disabled { background: #4b5563; color: #94a3b8; cursor: not-allowed; }
        .btn-secondary { background: #334155; }
        .screen { display: none; } .screen.active { display: block; animation: fadeIn 0.5s; }
        .option.correct { background-color: #22c55e !important; transform: scale(1.02); }
        .option.wrong { background-color: #ef4444 !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-white p-4">

    <div id="app-container" class="max-w-md mx-auto">
        <!-- Header Section -->
        <header class="flex justify-between items-center mb-4 p-4 glass-card rounded-lg">
            <div>
                <h1 class="text-xl font-bold text-amber-400">GK Academy</h1>
                <p id="user-greeting" class="text-sm text-slate-300">Welcome!</p>
            </div>
            <div id="auth-section">
                <button id="login-btn" class="btn-primary px-4 py-2 rounded-lg text-sm">Sign In</button>
                <div id="user-info" class="hidden items-center gap-2">
                    <button id="store-btn" class="btn-secondary p-2 rounded-full text-xs">Store</button>
                    <button id="profile-btn"><img id="user-pic" class="w-10 h-10 rounded-full border-2 border-amber-400" src=""></button>
                    <button id="logout-btn" class="btn-secondary p-2 rounded-full text-xs">Logout</button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main>
            <!-- Screen 1: Lobby -->
            <div id="lobby-screen" class="screen active">
                <h2 class="text-lg font-bold mb-2 text-amber-400">Daily Challenge</h2>
                <div id="tournaments-list" class="space-y-3"><p class="text-slate-400">Loading...</p></div>
            </div>

            <!-- Screen 2: Game -->
            <div id="game-screen" class="screen">
                 <div class="p-4 glass-card rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-bold text-amber-400">Game On!</h2>
                         <div class="text-center">
                            <p class="text-xs text-amber-400">50:50 Lifelines</p>
                            <p class="font-bold text-lg" id="lifeline-count-display">0</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-slate-400">Question</p>
                            <p class="font-bold text-xl"><span id="current-q-number">1</span>/10</p>
                        </div>
                    </div>
                    <p id="question-text" class="min-h-[80px] my-4 text-center flex items-center justify-center"></p>
                    <div id="options-container" class="space-y-3"></div>
                    <button id="use-lifeline-btn" class="w-full btn-secondary mt-4 py-2 rounded-lg">Use 50:50 Lifeline</button>
                </div>
            </div>

            <!-- Screen 3: Profile & Wallet -->
            <div id="profile-screen" class="screen">
                 <!-- Profile content here -->
                 <div class="p-4 glass-card rounded-lg">
                    <div class="text-center border-b border-slate-600 pb-4">
                        <img id="profile-pic-large" class="w-24 h-24 rounded-full mx-auto border-4 border-amber-400" src="">
                        <h2 id="profile-name" class="text-2xl font-bold mt-2"></h2>
                        <p id="profile-email" class="text-sm text-slate-400"></p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-center mt-4">
                        <div> <p class="text-slate-400">High Score</p> <p id="profile-highscore" class="text-2xl font-bold">0</p> </div>
                        <div> <p class="text-slate-400">Coins Wallet</p> <p id="profile-coins" class="text-2xl font-bold text-amber-400">0</p> </div>
                    </div>
                    <div class="mt-6">
                        <h3 class="font-bold text-amber-400 mb-2">Redeem Coins</h3>
                        <div class="space-y-3">
                            <div class="p-3 glass-card rounded-lg flex justify-between items-center">
                                <div><p class="font-bold">6410 Amazon Gift Card</p><p class="text-sm text-slate-400">Requires 1000 Coins</p></div>
                                <button class="btn-primary px-3 py-1 rounded-lg text-sm redeem-btn" data-cost="1000" data-item="Amazon Gift Card (Rs. 10)">Redeem</button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h3 class="font-bold text-amber-400 mb-2">Transaction History</h3>
                        <ul id="transaction-history" class="space-y-2 text-sm max-h-40 overflow-y-auto"></ul>
                    </div>
                    <button onclick="showScreen('lobby-screen')" class="w-full btn-secondary mt-6 py-2 rounded-lg">Back to Lobby</button>
                </div>
            </div>
            
            <!-- Screen 4: Store -->
            <div id="store-screen" class="screen">
                <div class="p-4 glass-card rounded-lg">
                    <h2 class="text-lg font-bold mb-4 text-amber-400">Lifeline Store</h2>
                    <div class="space-y-3">
                        <div class="p-3 glass-card rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-bold">5 x "50:50" Lifelines</p>
                                <p class="text-sm text-slate-400">Get a pack of five 50:50 lifelines.</p>
                            </div>
                            <button id="buy-lifeline-pack-btn" class="btn-primary px-4 py-2 rounded-lg text-sm">Buy for 6420</button>
                        </div>
                    </div>
                     <button onclick="showScreen('lobby-screen')" class="w-full btn-secondary mt-6 py-2 rounded-lg">Back to Lobby</button>
                </div>
            </div>
        </main>
    </div>

<script>
// ===================================================================
// 97 IMPORTANT NOTICE #1: Apni Firebase Project Configuration yahan paste karein
// ===================================================================
const firebaseConfig = {
    apiKey: "AIzaSyDTpSO-VzHEObfaigP9SMvGQ3gDL8GFvus",
    authDomain: "gk-academy-challenge.firebaseapp.com",
    projectId: "gk-academy-challenge",
    storageBucket: "gk-academy-challenge.firebasestorage.app",
    messagingSenderId: "484965904494",
    appId: "1:484965904494:web:4fc16108b710491076f67f",
    measurementId: "G-LJ43QCBRDN"
};
// ===================================================================
// 97 IMPORTANT NOTICE #2: Apni Razorpay Test Key ID yahan paste karein
// ===================================================================
const RAZORPAY_KEY_ID = "rzp_test_RJU11zaDAZzXKs";
// ===================================================================
// 97 IMPORTANT NOTICE #3: Apni Gemini API Key yahan paste karein
// ===================================================================
const GEMINI_API_KEY = "AIzaSyAoxCH_X1QNsflSO9Z9yxnJS0j9gC1JLKs";
const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

// --- App Initialization ---
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- DOM Elements ---
const userGreeting = document.getElementById('user-greeting');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const userInfo = document.getElementById('user-info');
const userPic = document.getElementById('user-pic');
const profileBtn = document.getElementById('profile-btn');
const storeBtn = document.getElementById('store-btn');

// --- Global State ---
let currentUser = null;

// --- Screen Navigation ---
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

// --- Authentication ---
auth.onAuthStateChanged(user => {
    if (user) {
        currentUser = user;
        loginBtn.classList.add('hidden'); userInfo.classList.remove('hidden');
        userPic.src = user.photoURL;
        userGreeting.textContent = `Hello, ${user.displayName.split(' ')[0]}!`;
        setupUser(user);
    } else {
        currentUser = null;
        loginBtn.classList.remove('hidden'); userInfo.classList.add('hidden');
        userGreeting.textContent = 'Welcome! Please sign in.';
        document.getElementById('tournaments-list').innerHTML = `<p class="text-slate-400">Please sign in to view tournaments.</p>`;
    }
});

loginBtn.addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()));
logoutBtn.addEventListener('click', () => auth.signOut());
profileBtn.addEventListener('click', () => showProfile());
storeBtn.addEventListener('click', () => showScreen('store-screen'));

// --- User & Profile Management ---
function setupUser(user) {
    const userRef = db.collection('users').doc(user.uid);
    userRef.onSnapshot(doc => {
        if (!doc.exists) {
            userRef.set({ 
                name: user.displayName, 
                email: user.email, 
                highScore: 0, 
                coins: 100, // Welcome bonus
                lifelines: { '50-50': 3 } // Starting lifelines
            });
        }
    });
    loadTournaments();
}

// ... (showProfile and other functions remain the same) ...
function showProfile() {
    if (!currentUser) return;
    const userRef = db.collection('users').doc(currentUser.uid);
    userRef.get().then(doc => {
        if (doc.exists) {
            const data = doc.data();
            document.getElementById('profile-pic-large').src = currentUser.photoURL;
            document.getElementById('profile-name').textContent = data.name;
            document.getElementById('profile-email').textContent = data.email;
            document.getElementById('profile-highscore').textContent = data.highScore || 0;
            document.getElementById('profile-coins').textContent = data.coins || 0;
        }
    });
    const historyList = document.getElementById('transaction-history');
    historyList.innerHTML = '<li>Loading history...</li>';
    db.collection('users').doc(currentUser.uid).collection('transactions')
      .orderBy('timestamp', 'desc').limit(10).onSnapshot(snapshot => {
        historyList.innerHTML = '';
        if (snapshot.empty) historyList.innerHTML = '<li class="text-slate-400">No transactions yet.</li>';
        snapshot.forEach(doc => {
            const tx = doc.data();
            const date = tx.timestamp.toDate().toLocaleDateString();
            const li = document.createElement('li');
            li.className = `flex justify-between p-2 rounded ${tx.type === 'credit' ? 'bg-green-900/50' : tx.type === 'debit' ? 'bg-red-900/50' : 'bg-blue-900/50'}`;
            li.innerHTML = `<div><p>${tx.description}</p><p class="text-xs text-slate-400">${date}</p></div><p class="font-bold">${tx.type === 'credit' ? '+' : '-'}${tx.amount}</p>`;
            historyList.appendChild(li);
        });
    });
    showScreen('profile-screen');
}

// --- Store and Payment Logic ---
document.getElementById('buy-lifeline-pack-btn').addEventListener('click', () => {
    if (!currentUser) return alert("Please sign in to make a purchase.");
    const options = {
        key: RAZORPAY_KEY_ID, amount: 2000, currency: "INR", name: "GK Academy Store",
        description: "Pack of 5 '50:50' Lifelines",
        handler: async (response) => {
            // In a real app, verify this on a backend. For this version, we trust the client.
            alert("Payment successful! 5 lifelines have been added to your account.");
            const userRef = db.collection('users').doc(currentUser.uid);
            await userRef.update({
                'lifelines.50-50': firebase.firestore.FieldValue.increment(5)
            });
             // Add transaction record
            const txRef = userRef.collection('transactions').doc();
            await txRef.set({
                amount: '6420.00', type: 'purchase', description: `Purchased 5 '50:50' Lifelines`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        },
        prefill: { name: currentUser.displayName, email: currentUser.email }
    };
    new Razorpay(options).open();
});


// --- Game Logic ---
let currentQuestions = [];
let questionIndex = 0;
let score = 0;
let usedLifelineThisQuestion = false;

function loadTournaments() {
    // This is a demo tournament. In a real app, you would manage this in Firestore.
    const listEl = document.getElementById('tournaments-list');
    listEl.innerHTML = `<div class="p-4 glass-card rounded-lg">
            <h3 class="font-bold text-lg">Daily GK Challenge</h3>
            <div class="flex justify-between items-center mt-2 text-sm">
                <p>Win <span class="font-bold text-amber-400">500 Coins</span></p>
                <button class="btn-primary px-4 py-2 rounded-lg text-sm start-game-btn">Play Now</button>
            </div>
        </div>`;
}

document.addEventListener('click', async e => {
    if (e.target.classList.contains('start-game-btn')) startGame();
    if (e.target.classList.contains('redeem-btn')) {
        const cost = parseInt(e.target.dataset.cost);
        const item = e.target.dataset.item;
        redeemItem(item, cost);
    }
});

async function startGame() {
    questionIndex = 0; score = 0;
    document.getElementById('question-text').textContent = 'Loading questions...';
    showScreen('game-screen');
    try {
        if (!GEMINI_API_KEY) throw new Error("API Key is missing");
        const response = await fetch(GEMINI_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: "Generate 10 unique KBC-style multiple choice questions in Hindi on 'General Knowledge'. Provide response as a valid JSON array. Each object should have keys: 'q' (question), 'o' (array of 4 options), and 'a' (the correct answer)." }] }],
                generationConfig: { responseMimeType: "application/json" }
            })
        });
        if (!response.ok) throw new Error("API Error");
        const result = await response.json();
        const dataText = result.candidates[0].content.parts[0].text;
        const cleanJsonText = dataText.replace(/```json/g, '').replace(/```/g, '').trim();
        currentQuestions = JSON.parse(cleanJsonText);
        displayQuestion();
    } catch(err) {
        alert("Could not load questions: " + err.message);
        showScreen('lobby-screen');
    }
}

function displayQuestion() {
    if (questionIndex >= currentQuestions.length) {
        endGame(); return;
    }
    usedLifelineThisQuestion = false; // Reset lifeline for new question
    const userRef = db.collection('users').doc(currentUser.uid);
    userRef.get().then(doc => { // Get latest lifeline count
        document.getElementById('lifeline-count-display').textContent = doc.data().lifelines['50-50'] || 0;
    });

    const qData = currentQuestions[questionIndex];
    document.getElementById('current-q-number').textContent = questionIndex + 1;
    document.getElementById('question-text').textContent = qData.q;
    const optionsEl = document.getElementById('options-container');
    optionsEl.innerHTML = '';
    qData.o.forEach(optionText => {
        const button = document.createElement('button');
        button.className = 'w-full text-left p-3 glass-card rounded-lg hover:bg-amber-500 hover:text-slate-800 transition-colors option';
        button.textContent = optionText;
        button.onclick = (e) => selectAnswer(e.target, optionText, qData.a);
        optionsEl.appendChild(button);
    });
}

function selectAnswer(buttonEl, selected, correct) {
    document.querySelectorAll('.option').forEach(b => b.disabled = true);
    if (selected === correct) {
        score += 10;
        buttonEl.classList.add('correct');
    } else {
        buttonEl.classList.add('wrong');
    }
    setTimeout(() => {
        questionIndex++;
        displayQuestion();
    }, 1500);
}

document.getElementById('use-lifeline-btn').addEventListener('click', async () => {
    if (!currentUser || usedLifelineThisQuestion) return;
    const userRef = db.collection('users').doc(currentUser.uid);
    const doc = await userRef.get();
    const currentLifelines = doc.data().lifelines['50-50'] || 0;

    if (currentLifelines > 0) {
        await userRef.update({ 'lifelines.50-50': firebase.firestore.FieldValue.increment(-1) });
        usedLifelineThisQuestion = true;
        
        const correctAns = currentQuestions[questionIndex].a;
        const options = document.querySelectorAll('.option');
        let removed = 0;
        options.forEach(opt => {
            if (opt.textContent !== correctAns && removed < 2) {
                opt.style.visibility = 'hidden';
                removed++;
            }
        });
    } else {
        alert("You have no 50:50 lifelines. Visit the store to buy more!");
    }
});

// ... (endGame and redeemItem functions remain the same) ...
async function endGame() {
    const coinsWon = score * 5;
    alert(`Game over! Your score is ${score}. You earned ${coinsWon} coins!`);
    if (!currentUser || coinsWon <= 0) {
        showScreen('lobby-screen'); return;
    }
    const userRef = db.collection('users').doc(currentUser.uid);
    await db.runTransaction(async (t) => {
        const doc = await t.get(userRef);
        const high = doc.data().highScore || 0;
        const updateData = { coins: firebase.firestore.FieldValue.increment(coinsWon) };
        if(score > high) updateData.highScore = score;
        t.update(userRef, updateData);
        const txRef = userRef.collection('transactions').doc();
        t.set(txRef, {
            amount: coinsWon, type: 'credit', description: `Won in Daily Quiz`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    });
    showScreen('lobby-screen');
}
async function redeemItem(item, cost) {
    if (!currentUser) return;
    const userRef = db.collection('users').doc(currentUser.uid);
    document.querySelectorAll('.redeem-btn').forEach(b => b.disabled = true);
    try {
        await db.runTransaction(async (t) => {
            const doc = await t.get(userRef);
            const coins = doc.data().coins || 0;
            if(coins < cost) throw "Not enough coins!";
            t.update(userRef, { coins: firebase.firestore.FieldValue.increment(-cost) });
            const txRef = userRef.collection('transactions').doc();
            t.set(txRef, { amount: cost, type: 'debit', description: `Redeemed ${item}`, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            const redeemRef = db.collection('redemptionRequests').doc();
            t.set(redeemRef, { userId: currentUser.uid, userName: currentUser.displayName, userEmail: currentUser.email, item, cost, status: 'pending', requestedAt: firebase.firestore.FieldValue.serverTimestamp() });
        });
        alert(`Successfully redeemed ${item}! You will receive it via email in 24-48 hours.`);
    } catch (err) {
        alert("Redemption failed: " + err);
    } finally {
        document.querySelectorAll('.redeem-btn').forEach(b => b.disabled = false);
    }
}

</script>
</body>
</html>