<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GK Academy Challenge - Live Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body { background-color: #0f172a; font-family: 'Poppins', sans-serif; }
        .glass-card { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-primary { background: #f59e0b; color: #1e293b; font-weight: bold; transition: all 0.2s; }
        .btn-primary:hover:not(:disabled) { background: #fbbf24; }
        .btn-primary:disabled { background: #4b5563; color: #94a3b8; cursor: not-allowed; }
        .btn-secondary { background: #334155; }
        .screen { display: none; } .screen.active { display: block; animation: fadeIn 0.5s; }
        .option.correct { background-color: #22c55e !important; transform: scale(1.02); }
        .option.wrong { background-color: #ef4444 !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-white p-4">

    <div id="app-container" class="max-w-md mx-auto">
        <!-- Header Section -->
        <header class="flex justify-between items-center mb-4 p-4 glass-card rounded-lg">
            <div>
                <h1 class="text-xl font-bold text-amber-400">GK Academy</h1>
                <p id="user-greeting" class="text-sm text-slate-300">Welcome!</p>
            </div>
            <div id="auth-section">
                <button id="login-btn" class="btn-primary px-4 py-2 rounded-lg text-sm">Sign In</button>
                <div id="user-info" class="hidden items-center gap-2">
                    <button id="profile-btn"><img id="user-pic" class="w-10 h-10 rounded-full border-2 border-amber-400" src=""></button>
                    <button id="logout-btn" class="btn-secondary p-2 rounded-full text-xs">Logout</button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main>
            <!-- Screen 1: Lobby -->
            <div id="lobby-screen" class="screen active">
                <h2 class="text-lg font-bold mb-2 text-amber-400">Daily Challenge</h2>
                <div id="tournaments-list" class="space-y-3"><p class="text-slate-400">Loading...</p></div>
            </div>

            <!-- Screen 2: Game -->
            <div id="game-screen" class="screen">
                 <div class="p-4 glass-card rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-bold text-amber-400">Game On!</h2>
                        <div class="text-right">
                            <p class="text-sm text-slate-400">Question</p>
                            <p class="font-bold text-xl"><span id="current-q-number">1</span>/10</p>
                        </div>
                    </div>
                    <p id="question-text" class="min-h-[80px] my-4 text-center flex items-center justify-center"></p>
                    <div id="options-container" class="space-y-3"></div>
                </div>
            </div>

            <!-- Screen 3: Profile & Wallet -->
            <div id="profile-screen" class="screen">
                <div class="p-4 glass-card rounded-lg">
                    <div class="text-center border-b border-slate-600 pb-4">
                        <img id="profile-pic-large" class="w-24 h-24 rounded-full mx-auto border-4 border-amber-400" src="">
                        <h2 id="profile-name" class="text-2xl font-bold mt-2"></h2>
                        <p id="profile-email" class="text-sm text-slate-400"></p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-center mt-4">
                        <div>
                            <p class="text-slate-400">High Score</p>
                            <p id="profile-highscore" class="text-2xl font-bold">0</p>
                        </div>
                        <div>
                            <p class="text-slate-400">Coins Wallet</p>
                            <p id="profile-coins" class="text-2xl font-bold text-amber-400">0</p>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="font-bold text-amber-400 mb-2">Redeem Coins</h3>
                        <div class="space-y-3">
                            <div class="p-3 glass-card rounded-lg flex justify-between items-center">
                                <div>
                                    <p class="font-bold">6410 Amazon Gift Card</p>
                                    <p class="text-sm text-slate-400">Requires 1000 Coins</p>
                                </div>
                                <button class="btn-primary px-3 py-1 rounded-lg text-sm redeem-btn" data-cost="1000" data-item="Amazon Gift Card (Rs. 10)">Redeem</button>
                            </div>
                             <div class="p-3 glass-card rounded-lg flex justify-between items-center">
                                <div>
                                    <p class="font-bold">6450 Google Play Card</p>
                                    <p class="text-sm text-slate-400">Requires 5000 Coins</p>
                                </div>
                                <button class="btn-primary px-3 py-1 rounded-lg text-sm redeem-btn" data-cost="5000" data-item="Google Play Card (Rs. 50)">Redeem</button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h3 class="font-bold text-amber-400 mb-2">Transaction History</h3>
                        <ul id="transaction-history" class="space-y-2 text-sm max-h-40 overflow-y-auto"></ul>
                    </div>

                    <button onclick="showScreen('lobby-screen')" class="w-full btn-secondary mt-6 py-2 rounded-lg">Back to Lobby</button>
                </div>
            </div>
        </main>
    </div>

<script>
// ===================================================================
// 97 IMPORTANT NOTICE #1: Apni Firebase Project Configuration yahan paste karein
// ===================================================================
const firebaseConfig = {
    apiKey: "AIzaSyDTpSO-VzHEObfaigP9SMvGQ3gDL8GFvus",
    authDomain: "gk-academy-challenge.firebaseapp.com",
    projectId: "gk-academy-challenge",
    storageBucket: "gk-academy-challenge.firebasestorage.app",
    messagingSenderId: "484965904494",
    appId: "1:484965904494:web:4fc16108b710491076f67f",
    measurementId: "G-LJ43QCBRDN"
};
// ===================================================================
// 97 IMPORTANT NOTICE #2: Apni Razorpay Test Key ID yahan paste karein
// Iska upyog abhi is version mein nahin hai, par bhavishya ke liye hai.
// ===================================================================
const RAZORPAY_KEY_ID = "rzp_test_RJU11zaDAZzXKs";
// ===================================================================
// 97 IMPORTANT NOTICE #3: Apni Gemini API Key yahan paste karein
// ===================================================================
const GEMINI_API_KEY = "AIzaSyB7SDXrRCBTLC-6Uv8ZVnf2DD2BWZu9UMY";
const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

// --- App Initialization ---
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- DOM Elements ---
const userGreeting = document.getElementById('user-greeting');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const userInfo = document.getElementById('user-info');
const userPic = document.getElementById('user-pic');
const profileBtn = document.getElementById('profile-btn');

// --- Global State ---
let currentUser = null;

// --- Screen Navigation ---
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

// --- Authentication ---
auth.onAuthStateChanged(user => {
    if (user) {
        currentUser = user;
        loginBtn.classList.add('hidden'); userInfo.classList.remove('hidden');
        userPic.src = user.photoURL;
        userGreeting.textContent = `Hello, ${user.displayName.split(' ')[0]}!`;
        setupUser(user);
    } else {
        currentUser = null;
        loginBtn.classList.remove('hidden'); userInfo.classList.add('hidden');
        userGreeting.textContent = 'Welcome! Please sign in.';
        document.getElementById('tournaments-list').innerHTML = `<p class="text-slate-400">Please sign in to view tournaments.</p>`;
    }
});

loginBtn.addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()));
logoutBtn.addEventListener('click', () => auth.signOut());
profileBtn.addEventListener('click', () => showProfile());

// --- User & Profile Management ---
function setupUser(user) {
    const userRef = db.collection('users').doc(user.uid);
    userRef.onSnapshot(doc => {
        if (!doc.exists) {
            userRef.set({ 
                name: user.displayName, 
                email: user.email, 
                highScore: 0, 
                coins: 100 // Welcome bonus
            });
        }
    });
    loadTournaments();
}

function showProfile() {
    if (!currentUser) return;
    const userRef = db.collection('users').doc(currentUser.uid);
    userRef.get().then(doc => {
        if (doc.exists) {
            const data = doc.data();
            document.getElementById('profile-pic-large').src = currentUser.photoURL;
            document.getElementById('profile-name').textContent = data.name;
            document.getElementById('profile-email').textContent = data.email;
            document.getElementById('profile-highscore').textContent = data.highScore || 0;
            document.getElementById('profile-coins').textContent = data.coins || 0;
        }
    });

    const historyList = document.getElementById('transaction-history');
    historyList.innerHTML = '<li>Loading history...</li>';
    db.collection('users').doc(currentUser.uid).collection('transactions')
      .orderBy('timestamp', 'desc').limit(10).onSnapshot(snapshot => {
        historyList.innerHTML = '';
        if (snapshot.empty) {
            historyList.innerHTML = '<li class="text-slate-400">No transactions yet.</li>';
            return;
        }
        snapshot.forEach(doc => {
            const tx = doc.data();
            const date = tx.timestamp.toDate().toLocaleDateString();
            const li = document.createElement('li');
            li.className = `flex justify-between p-2 rounded ${tx.type === 'credit' ? 'bg-green-900/50' : 'bg-red-900/50'}`;
            li.innerHTML = `<div><p>${tx.description}</p><p class="text-xs text-slate-400">${date}</p></div><p class="font-bold">${tx.type === 'credit' ? '+' : '-'}${tx.amount}</p>`;
            historyList.appendChild(li);
        });
    });
    showScreen('profile-screen');
}

// --- Tournament and Game Logic ---
let currentQuestions = [];
let questionIndex = 0;
let score = 0;

function loadTournaments() {
    const tourneyRef = db.collection('tournaments').doc('daily_quiz');
    tourneyRef.get().then(doc => {
        if (!doc.exists) {
            tourneyRef.set({ name: "Daily GK Challenge", reward: 500, status: "live" });
        }
    });
    
    db.collection('tournaments').where('status', '==', 'live').onSnapshot(snapshot => {
        const listEl = document.getElementById('tournaments-list');
        listEl.innerHTML = '';
        if(snapshot.empty){
            listEl.innerHTML = `<div class="p-4 glass-card rounded-lg text-center text-slate-400">No live tournaments right now. Come back later!</div>`;
            return;
        }
        snapshot.forEach(doc => {
            const tournament = doc.data();
            const card = document.createElement('div');
            card.className = 'p-4 glass-card rounded-lg';
            card.innerHTML = `<h3 class="font-bold text-lg">${tournament.name}</h3>
                <div class="flex justify-between items-center mt-2 text-sm">
                    <p>Win <span class="font-bold text-amber-400">${tournament.reward} Coins</span></p>
                    <button class="btn-primary px-4 py-2 rounded-lg text-sm start-game-btn">Play Now</button>
                </div>`;
            listEl.appendChild(card);
        });
    });
}

document.addEventListener('click', async e => {
    if (e.target.classList.contains('start-game-btn')) {
        startGame();
    }
    if (e.target.classList.contains('redeem-btn')) {
        const cost = parseInt(e.target.dataset.cost);
        const item = e.target.dataset.item;
        redeemItem(item, cost);
    }
});

async function startGame() {
    questionIndex = 0;
    score = 0;
    document.getElementById('question-text').textContent = 'Loading questions...';
    showScreen('game-screen');
    
    try {
        if (!GEMINI_API_KEY) throw new Error("API Key is missing or invalid.");
        const response = await fetch(GEMINI_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: "Generate 10 unique KBC-style multiple choice questions in Hindi on 'General Knowledge'. Provide the response as a valid JSON array. Each object should have keys: 'q' (question), 'o' (array of 4 options), and 'a' (the correct answer)." }] }],
                generationConfig: { responseMimeType: "application/json" }
            })
        });
        if (!response.ok) throw new Error("API responded with an error.");
        const result = await response.json();
        const dataText = result.candidates[0].content.parts[0].text;
        const cleanJsonText = dataText.replace(/```json/g, '').replace(/```/g, '').trim();
        currentQuestions = JSON.parse(cleanJsonText);
        displayQuestion();
    } catch(err) {
        alert("Could not load questions: " + err.message + "\nPlease check your Gemini API Key and ensure the API is enabled in your Google Cloud project.");
        showScreen('lobby-screen');
    }
}

function displayQuestion() {
    if (questionIndex >= currentQuestions.length) {
        endGame();
        return;
    }
    const qData = currentQuestions[questionIndex];
    document.getElementById('current-q-number').textContent = questionIndex + 1;
    document.getElementById('question-text').textContent = qData.q;
    const optionsEl = document.getElementById('options-container');
    optionsEl.innerHTML = '';
    qData.o.forEach(optionText => {
        const button = document.createElement('button');
        button.className = 'w-full text-left p-3 glass-card rounded-lg hover:bg-amber-500 hover:text-slate-800 transition-colors option';
        button.textContent = optionText;
        button.onclick = (e) => selectAnswer(e.target, optionText, qData.a);
        optionsEl.appendChild(button);
    });
}

function selectAnswer(buttonEl, selected, correct) {
    document.querySelectorAll('.option').forEach(b => b.disabled = true);
    if (selected === correct) {
        score += 10;
        buttonEl.classList.add('correct');
    } else {
        buttonEl.classList.add('wrong');
    }
    setTimeout(() => {
        questionIndex++;
        displayQuestion();
    }, 1500);
}

async function endGame() {
    const coinsWon = score * 5; // 10 points = 50 coins
    alert(`Game over! Your score is ${score}. You earned ${coinsWon} coins!`);
    
    if (!currentUser || coinsWon <= 0) {
        showScreen('lobby-screen');
        return;
    }
    
    const userRef = db.collection('users').doc(currentUser.uid);
    await db.runTransaction(async (transaction) => {
        const userDoc = await transaction.get(userRef);
        const currentHighScore = userDoc.data().highScore || 0;
        
        const updateData = {
            coins: firebase.firestore.FieldValue.increment(coinsWon)
        };
        if(score > currentHighScore) {
            updateData.highScore = score;
        }
        transaction.update(userRef, updateData);

        const txRef = userRef.collection('transactions').doc();
        transaction.set(txRef, {
            amount: coinsWon,
            type: 'credit',
            description: `Won in Daily Quiz`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    });
    
    showScreen('lobby-screen');
}

async function redeemItem(item, cost) {
    if (!currentUser) return;
    const userRef = db.collection('users').doc(currentUser.uid);
    document.querySelectorAll('.redeem-btn').forEach(b => b.disabled = true);
    try {
        await db.runTransaction(async (transaction) => {
            const userDoc = await transaction.get(userRef);
            const currentCoins = userDoc.data().coins || 0;
            if(currentCoins < cost) {
                throw "Not enough coins!";
            }
            transaction.update(userRef, {
                coins: firebase.firestore.FieldValue.increment(-cost)
            });
            const txRef = userRef.collection('transactions').doc();
            transaction.set(txRef, {
                amount: cost, type: 'debit', description: `Redeemed ${item}`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            const redeemRef = db.collection('redemptionRequests').doc();
            transaction.set(redeemRef, {
                userId: currentUser.uid, userName: currentUser.displayName, userEmail: currentUser.email,
                item: item, cost: cost, status: 'pending',
                requestedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        alert(`Successfully redeemed ${item}! You will receive it via email in 24-48 hours.`);
    } catch (err) {
        alert("Redemption failed: " + err.message);
    } finally {
        document.querySelectorAll('.redeem-btn').forEach(b => b.disabled = false);
    }
}
</script>
</body>
</html>